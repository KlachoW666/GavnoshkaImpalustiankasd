# План реструктуризации CLABX

## Кратко: что такое реструктуризация

**Реконструкция сайта** — это переход от единого потока для всех пользователей к **двум режимам работы** с разным интерфейсом и балансами:

1. **Авто-Торговля** — текущий сценарий: свои ключи Bitget, сигналы AI, авто-исполнение, графики, демо.
2. **Копитрейдинг** — режим инвестора: отдельный баланс, пополнение/вывод через админа, подписки на провайдеров, статистика, PnL, история операций со статусами.

Режим можно **менять в любой момент** (не только при первом входе). Меню и ключевые страницы должны подстраиваться под выбранный режим. Для полной автоматической работы проекта нужно довести до конца интеграцию онбординга, расширенного UI копитрейдинга, админки операций и проверки прав.

---

## 1. Цель и контекст

Пользователь хочет кардинально изменить структуру сайта:

- **После регистрации** — выбор между двумя режимами:
  - **Авто-Торговля** (стандартный доступ)
  - **Копитрейдинг** (с расширенным функционалом)
- Для **копитрейдинга** добавить:
  - Статистика
  - Количество участников
  - Пополнение счёта
  - История пополнений
  - Статусы (ожидание, поступили, обработка и т.д.)

### Принятые решения

| Вопрос | Решение |
|--------|--------|
| Режим выбора | Переключение в любой момент (не одноразовый) |
| Баланс | Отдельный баланс копитрейдинга |
| Функционал | Полный функционал инвестора (статистика, история пополнений, статусы депозитов, PnL, графики) |
| Провайдеры | Отбираются админом |

---

## 2. Онбординг — экран выбора режима

После регистрации показывается экран выбора режима работы.

**Файл:** `frontend/src/pages/OnboardingPage.tsx`

```
┌─────────────────────────────────────────────────────────┐
│                    Добро пожаловать в CLABX!            │
│                                                         │
│  Выберите режим работы:                                 │
│                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐      │
│  │   🤖 АВТО-ТОРГОВЛЯ   │  │   👥 КОПИТРЕЙДИНГ   │      │
│  │                     │  │                     │      │
│  │  • Сигналы AI       │  │  • Копирование      │      │
│  │  • Авто-исполнение  │  │    успешных трейдеров│      │
│  │  • Свои настройки   │  │  • Статистика        │      │
│  │  • Bitget API       │  │  • Управление       │      │
│  │                     │  │    средствами       │      │
│  │  [Выбрать]          │  │  [Выбрать]          │      │
│  └─────────────────────┘  └─────────────────────┘      │
│                                                         │
│  Можно изменить в любой момент в настройках             │
└─────────────────────────────────────────────────────────┘
```

---

## 3. Страница «Копитрейдинг» — макет

**Файл:** `frontend/src/pages/CopyTradingPage.tsx` (полностью переработанная)

```
┌─────────────────────────────────────────────────────────┐
│  КОПИТРЕЙДИНГ                                           │
├─────────────────────────────────────────────────────────┤
│  📊 Мой портфель                                        │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Баланс: 1,234.56 USDT                             │  │
│  │  PnL (30д): +$234.50 (+19.2%)                      │  │
│  │  [Пополнить]  [Вывести]  [История]                 │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  👥 Мои подписки                                        │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Трейдер    | PnL    | Win% | Подписчики | Действие│  │
│  │  ────────────────────────────────────────────────  │  │
│  │  @trader1   | +$450  | 72%  | 156        | [Отпис.]│  │
│  │  @trader2   | +$120  | 65%  | 89         | [Отпис.]│  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  🏆 Рейтинг провайдеров                                 │
│  [Фильтры: Период | Win% | Подписчики]                  │
│  ┌───────────────────────────────────────────────────┐  │
│  │  #1  @pro_trader  | +$12,450 | 78% | 1.2K | [Подп.]│  │
│  │  #2  @crypto_king | +$8,900  | 71% | 856  | [Подп.]│  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  📈 График PnL                                          │
│  [Lightweight Charts - исторический PnL]                │
│                                                         │
│  📋 История операций                                    │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Дата      | Тип      | Сумма    | Статус         │  │
│  │  22.02.26  | Пополн.  | +100 USDT| ✅ Зачислено   │  │
│  │  21.02.26  | Вывод    | -50 USDT | ⏳ В обработке │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

**Секции страницы:**

- **Портфель** — баланс, PnL, кнопки пополнения/вывода/истории
- **Мои подписки** — активные подписки с детальной статистикой
- **Рейтинг провайдеров** — таблица с сортировкой и фильтрами
- **График PnL** — исторический PnL (Lightweight Charts)
- **История операций** — статусы: Ожидание → В обработке → Зачислено/Отклонено

---

## 4. Адаптивный интерфейс по режиму

| Элемент | Авто-Торговля | Копитрейдинг |
|---------|----------------|--------------|
| Главное меню | Dashboard, Сигналы, График, Авто-трейд, Демо | Dashboard, Копитрейдинг, Провайдеры, Кошелёк |
| Ключевая страница | AutoTradingPage | CopyTradingPage (расширенная) |
| Баланс | Общий USDT кошелёк | Отдельный баланс копитрейдинга |

---

## 5. Backend — БД и режим пользователя

**Режим пользователя:** новое поле в таблице `users`:

- `user_mode`: `'auto_trading'` | `'copy_trading'`
- API: `POST /api/user/mode`, `GET /api/user/mode`

### Новые таблицы БД

```sql
-- Баланс копитрейдинга (отдельный от основного кошелька)
CREATE TABLE copy_trading_balances (
  user_id TEXT PRIMARY KEY,
  balance_usdt REAL DEFAULT 0,
  total_pnl REAL DEFAULT 0,
  created_at TEXT DEFAULT datetime('now'),
  updated_at TEXT DEFAULT datetime('now')
);

-- История операций (пополнения/выводы)
CREATE TABLE copy_trading_transactions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  type TEXT NOT NULL,       -- 'deposit' | 'withdraw' | 'pnl_credit' | 'pnl_debit'
  amount_usdt REAL NOT NULL,
  status TEXT DEFAULT 'pending',  -- 'pending' | 'processing' | 'completed' | 'rejected'
  tx_hash TEXT,
  admin_note TEXT,
  created_at TEXT DEFAULT datetime('now'),
  processed_at TEXT,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Режим пользователя
ALTER TABLE users ADD COLUMN user_mode TEXT DEFAULT 'auto_trading';
```

### API endpoints (копитрейдинг и режим)

| Endpoint | Method | Описание |
|----------|--------|----------|
| `/api/copy-trading/balance` | GET | Баланс копитрейдинга |
| `/api/copy-trading/deposit` | POST | Создать заявку на пополнение |
| `/api/copy-trading/withdraw` | POST | Создать заявку на вывод |
| `/api/copy-trading/transactions` | GET | История операций с пагинацией |
| `/api/copy-trading/pnl-history` | GET | История PnL для графиков |
| `/api/copy-trading/providers/:id/stats` | GET | Детальная статистика провайдера |
| `/api/user/mode` | GET / POST | Получить / установить режим |

---

## 6. Файловая структура изменений

### Frontend (новые/изменённые файлы)

```
frontend/src/
├── pages/
│   ├── OnboardingPage.tsx        # Экран выбора режима
│   ├── CopyTradingPage.tsx       # Полностью переработанная
│   └── AdminPanel/
│       ├── AdminCopyProviders.tsx  # Управление провайдерами
│       └── AdminCopyOperations.tsx # Управление операциями
├── components/
│   ├── CopyTrading/
│   │   ├── PortfolioCard.tsx      # Карточка портфеля
│   │   ├── ProvidersTable.tsx     # Таблица провайдеров
│   │   ├── TransactionHistory.tsx # История операций
│   │   ├── PnlChart.tsx           # График PnL
│   │   └── DepositWithdraw.tsx     # Пополнение/вывод
│   └── Onboarding/
│       └── ModeSelector.tsx       # Выбор режима
└── store/
    └── userModeStore.ts           # Состояние режима
```

### Backend (новые файлы)

```
backend/src/
├── routes/
│   ├── copyTrading.ts             # Расширенный API
│   └── userMode.ts                # API режима
├── db/
│   └── copyTradingBalanceDb.ts    # Операции с балансом
└── services/
    └── copyTradingStatsService.ts  # Подсчёт статистики
```

---

## 7. Админ-панель: управление копитрейдингом

Новые разделы:

- **Провайдеры** — назначение/удаление провайдеров, редактирование статистики
- **Операции** — подтверждение пополнений/выводов, статусы
- **Балансы** — просмотр и корректировка балансов

---

## 8. Очередность реализации

| Этап | Задачи | Оценка |
|------|--------|--------|
| 1. Backend | Новые таблицы, API режима, API балансов | ~3 файла |
| 2. Onboarding | Экран выбора после регистрации | 2 файла |
| 3. CopyTrading UI | Переработка страницы, компоненты | 6 файлов |
| 4. Админка | Управление провайдерами и операциями | 2 файла |
| 5. Навигация | Адаптивное меню по режиму | 1 файл |

---

## 9. Что реализовано и что не реализовано

Ниже — чеклист для **полной автоматической работы** проекта в рамках реструктуризации (онбординг, копитрейдинг, админка).

### Backend

| Компонент | Статус | Примечание |
|-----------|--------|------------|
| Таблицы `copy_trading_balances`, `copy_trading_transactions` | ✅ | В т.ч. в SQLite и memory-store |
| Поле `user_mode` в `users` | ✅ | Миграция в `db/index.ts` |
| API `GET/POST /api/user/mode` | ✅ | Роут `userMode.ts` |
| API `/api/copy-trading-api/balance` | ✅ | Баланс копитрейдинга |
| API `/api/copy-trading-api/deposit`, `withdraw` | ✅ | Заявки на пополнение/вывод |
| API `/api/copy-trading-api/transactions` | ✅ | История с пагинацией/фильтром |
| API `/api/copy-trading-api/providers`, `providers/:id/stats` | ✅ | Провайдеры и статистика |
| API `/api/copy-trading-api/pnl-history` | ❌ | Нет — нужен для графика PnL |
| Admin: проверка прав на `/admin/*` в copy-trading-api | ❌ | Есть только `getUserId`, в коде помечено «TODO: check admin role» |
| Admin: обработка выводов в `admin/process/:txId` | ⚠️ | Всегда вызывается `processDeposit`; для вывода нужен вызов `processWithdraw` по типу операции |

### Frontend

| Компонент | Статус | Примечание |
|-----------|--------|------------|
| Страница `OnboardingPage.tsx` | ✅ | Выбор режима, вызов `onComplete(mode)` |
| Подключение онбординга после регистрации/логина | ❌ | В `App.tsx` нет маршрута и условия «показать онбординг, если режим не выбран» |
| Сохранение выбранного режима через API (`POST /api/user/mode`) | ❌ | OnboardingPage не вызывает API, только `onComplete` |
| Компоненты `PortfolioCard`, `DepositWithdraw`, `TransactionHistory` | ✅ | Есть и используют `/copy-trading-api/` |
| Интеграция портфеля в `CopyTradingPage` | ❌ | CopyTradingPage не рендерит PortfolioCard, DepositWithdraw, TransactionHistory — только подписки и таблицу провайдеров |
| Компонент `PnlChart.tsx` (график PnL) | ❌ | Не создан; нет API `pnl-history` |
| Компонент `ModeSelector.tsx` (переключение режима в настройках) | ❌ | Не создан |
| Хранилище/контекст режима (`userModeStore` или в профиле) | ❌ | Режим с бэкенда не подтягивается, меню не зависит от него |
| Адаптивное меню по `user_mode` | ❌ | Один общий список страниц (ALL_PAGES), без разделения «Авто-Торговля» / «Копитрейдинг» |

### Админ-панель

| Компонент | Статус | Примечание |
|-----------|--------|------------|
| Страницы `AdminCopyProviders.tsx`, `AdminCopyOperations.tsx` | ❌ | Нет в `AdminPanel`; управление провайдерами и операциями только через API |
| Раздел «Операции»: список заявок, подтверждение/отклонение пополнений и выводов | ❌ | API есть (`/admin/pending`, `/admin/process/:txId`), UI в админке отсутствует |
| Раздел «Провайдеры»: добавление/удаление провайдеров | ❌ | API есть, отдельной страницы в админке нет |
| Раздел «Балансы»: просмотр/корректировка балансов копитрейдинга | ❌ | Не реализовано |

---

## 10. Что доделать для полной автоматической работы

Чтобы проект работал **полностью автоматически** в рамках реструктуризации:

1. **Онбординг в потоке входа**  
   После регистрации или первого входа показывать `OnboardingPage`, если у пользователя не задан `user_mode`; при выборе режима вызывать `POST /api/user/mode` и сохранять выбор; затем переходить в приложение.

2. **Режим в настройках**  
   В настройках (или в шапке) дать переключатель режима с вызовом `POST /api/user/mode` и обновлением меню без перезагрузки.

3. **Единый API для копитрейдинга**  
   Привести пути к одному виду: либо все под `/api/copy-trading/...` (balance, deposit, withdraw, transactions), либо явно документировать использование `/api/copy-trading-api/...`, чтобы фронт и бэкенд совпадали.

4. **Расширенная страница «Копитрейдинг»**  
   На `CopyTradingPage` добавить блоки: портфель (PortfolioCard), пополнение/вывод (модалки DepositWithdraw), история операций (TransactionHistory). Сверху или в табах оставить «Мои подписки» и «Рейтинг провайдеров».

5. **График PnL**  
   Реализовать API `GET /api/copy-trading-api/pnl-history` (точечные данные по времени и PnL) и компонент `PnlChart.tsx` (например, на Lightweight Charts), встроить его в `CopyTradingPage`.

6. **Админка: операции**  
   Страница (например, `AdminCopyOperations.tsx`): список заявок из `GET /api/copy-trading-api/admin/pending` с кнопками «Подтвердить» / «Отклонить» и вызовом `POST /api/copy-trading-api/admin/process/:txId` с `action: 'approve' | 'reject'`. Для выводов на бэкенде в `admin/process` вызывать `processWithdraw` для типа `withdraw`, а не только `processDeposit`.

7. **Админка: провайдеры**  
   Страница `AdminCopyProviders.tsx`: список провайдеров, добавление по `userId`, удаление. Защитить все эндпоинты `/api/copy-trading-api/admin/*` проверкой роли админа (например, `requireAdmin`).

8. **Меню по режиму**  
   При `user_mode === 'copy_trading'` показывать укороченное/другое меню (например: Dashboard, Копитрейдинг, Провайдеры, Кошелёк, Настройки), при `auto_trading` — текущий полный список (Dashboard, Сигналы, График, Авто-трейд, Демо, …). Режим брать из `GET /api/user/mode` при загрузке и после смены в настройках.

После выполнения пунктов 1–8 реструктуризация будет доведена до состояния полной автоматической работы: выбор и смена режима, отдельный баланс и операции копитрейдинга, админское подтверждение заявок и управление провайдерами, единый UI без ручных обходов.

---

*Документ сформирован из плана реструктуризации CLABX (выбор режима Авто-Торговля / Копитрейдинг, расширенный копитрейдинг с балансом, пополнением, историей и статусами).*
