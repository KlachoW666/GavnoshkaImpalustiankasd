# Подключение внешнего ИИ (OpenAI / Claude)

Внешний платный ИИ добавляет **дополнительный фильтр** перед открытием позиции: сигнал отправляется в выбранную модель (OpenAI GPT-4o-mini или Claude Haiku), модель возвращает оценку 0–1. Если оценка ниже порога, заданного в админке, ордер не открывается.

**Важно:** 100% вероятности прибыли гарантировать невозможно. Сервис лишь снижает долю слабых сделок.

---

## 1. Где настраивать

**Все настройки задаются в админ-панели** → вкладка **«Внешний ИИ»**:

- Включение/выключение внешнего ИИ
- Провайдер: **OpenAI** (GPT-4o-mini) или **Claude** (Haiku)
- Минимальная оценка (0–100%): ордер не откроется, если ИИ вернёт ниже
- **API-ключи** — вводятся в полях «OpenAI API Key» и «Anthropic (Claude) API Key» и сохраняются на сервере (в БД, в зашифрованном виде при заданном `ENCRYPTION_KEY`)

Ключи можно по-прежнему задать в `.env` (`OPENAI_API_KEY`, `ANTHROPIC_API_KEY`) — они используются, если в админке ключ не задан.

---

## 2. OpenAI

1. Зарегистрируйтесь на [platform.openai.com](https://platform.openai.com).
2. Создайте API-ключ: **API Keys** → **Create new secret key**.
3. В админ-панели → **Внешний ИИ** → в поле **OpenAI API Key** вставьте ключ (`sk-proj-…`) и нажмите **«Сохранить всё»**.
4. Выберите провайдер **OpenAI**, включите внешний ИИ и задайте минимальную оценку (например, 60%).

**Модель:** `gpt-4o-mini`. Тарификация по [OpenAI Pricing](https://openai.com/pricing).

---

## 3. Claude (Anthropic)

1. Зарегистрируйтесь на [console.anthropic.com](https://console.anthropic.com).
2. Создайте API-ключ в разделе **API Keys**.
3. В админке в поле **Anthropic (Claude) API Key** вставьте ключ (`sk-ant-…`) и нажмите **«Сохранить всё»**.
4. Выберите провайдер **Claude**, включите внешний ИИ и задайте минимальную оценку.

**Модель:** `claude-3-5-haiku-20241022`. Тарификация по [Anthropic Pricing](https://www.anthropic.com/pricing).

---

## 4. Проверка

- В админке на вкладке «Внешний ИИ» для каждого провайдера отображается **«ключ задан»**, если ключ сохранён (из админки или из `.env`).
- Если ключ не задан или неверный, при включённом внешнем ИИ ордера не блокируются по этому фильтру (в логах — предупреждение).

---

## 5. Порядок фильтров перед открытием ордера

1. Исполнение включено и есть ключи OKX.
2. Risk/Reward ≥ 1.25.
3. Внутренний AI-фильтр (minAiProb), если включён и модель «тёплая».
4. **Внешний ИИ (OpenAI/Claude)**, если включён и ключ задан: оценка ≥ порог из админки.
5. Открытие ордера через OKX.

При ошибке или таймауте вызова внешнего ИИ ордер **не блокируется**.

---

## 6. Безопасность и шифрование ключей

- Ключи, введённые в админке, сохраняются в БД. На фронте они **никогда не отображаются** (только статус «ключ задан»).
- Для шифрования ключей в БД задайте в `.env` на сервере переменную **`ENCRYPTION_KEY`** (произвольная строка, например пароль). Без неё ключи хранятся в Base64 (обфускация), с нею — AES-256-GCM.
- Опционально ключи можно задать в `.env` (`OPENAI_API_KEY`, `ANTHROPIC_API_KEY`) — они используются, если в БД ключ не задан.
