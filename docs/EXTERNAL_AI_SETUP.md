   # Подключение внешнего ИИ (OpenAI / Claude)

   Внешний платный ИИ добавляет **дополнительный фильтр** перед открытием позиции: сигнал отправляется в выбранную модель (OpenAI GPT-4o-mini или Claude Haiku), модель возвращает оценку 0–1. Если оценка ниже порога, заданного в админке, ордер не открывается.

   **Важно:** 100% вероятности прибыли гарантировать невозможно. Сервис лишь снижает долю слабых сделок.

   ---

   ## 1. Где настраивать

   **Все настройки задаются в админ-панели** → вкладка **«Внешний ИИ»**:

   - Включение/выключение внешнего ИИ
   - Провайдер: **OpenAI** (GPT-4o-mini) или **Claude** (Haiku)
   - Минимальная оценка (0–100%): ордер не откроется, если ИИ вернёт ниже
   - **API-ключи** — вводятся в полях «OpenAI API Key» и «Anthropic (Claude) API Key» и сохраняются на сервере (в БД, в зашифрованном виде при заданном `ENCRYPTION_KEY`)

   Ключи можно по-прежнему задать в `.env` (`OPENAI_API_KEY`, `ANTHROPIC_API_KEY`) — они используются, если в админке ключ не задан.

   ---

   ## 2. OpenAI

   1. Зарегистрируйтесь на [platform.openai.com](https://platform.openai.com).
   2. Создайте API-ключ: **API Keys** → **Create new secret key**.
   3. В админ-панели → **Внешний ИИ** → в поле **OpenAI API Key** вставьте ключ (`sk-proj-…`) и нажмите **«Сохранить всё»**.
   4. Выберите провайдер **OpenAI**, включите внешний ИИ и задайте минимальную оценку (например, 60%).

   **Модель:** `gpt-4o-mini`. Тарификация по [OpenAI Pricing](https://openai.com/pricing).

   ---

   ## 3. Claude (Anthropic)

   1. Зарегистрируйтесь на [console.anthropic.com](https://console.anthropic.com).
   2. Создайте API-ключ в разделе **API Keys**.
   3. В админке в поле **Anthropic (Claude) API Key** вставьте ключ (`sk-ant-…`) и нажмите **«Сохранить всё»**.
   4. Выберите провайдер **Claude**, включите внешний ИИ и задайте минимальную оценку.

   **Модель:** `claude-3-5-haiku-20241022`. Тарификация по [Anthropic Pricing](https://www.anthropic.com/pricing).

   ---

   ## 4. Прокси для OpenAI и Claude

   Запросы к **OpenAI** и **Claude** идут через те же прокси, что и OKX: из **PROXY_LIST** в `.env` и добавленные вручную в админке (вкладка «Прокси»). Это нужно, чтобы обойти блокировку по региону (403 «Country not supported»).

   Если прокси заданы и работают (в админке отображаются как «Работает»), запросы к внешнему ИИ выполняются через случайный прокси из списка. В логах при этом будет строка вида `OpenAI request via proxy`.

   Если после включения прокси всё равно приходит 403 — IP выбранного прокси тоже может быть в заблокированном регионе. Попробуйте другой прокси из списка или провайдер **Claude**.

   ---

   ## 5. OpenAI 401: «Incorrect API key provided»

   Если в логах **401** и «Incorrect API key» — ключ неверный или отозван.

   **Что сделать:**
   1. Откройте [platform.openai.com → API Keys](https://platform.openai.com/account/api-keys).
   2. Создайте новый ключ (старый при необходимости отзовите).
   3. В админке → Внешний ИИ: **очистите** поле OpenAI API Key, **вставьте ключ целиком** (должен начинаться с `sk-proj-` или `sk-`), нажмите «Сохранить всё».

   Ключ копируйте полностью, без пробелов в начале и конце.

   ---

   ## 6. OpenAI 403: «Country / region not supported»

   Если в логах появляется **`unsupported_country_region_territory`** или **403** от OpenAI:

   - Убедитесь, что в админке заданы рабочие прокси (вкладка «Прокси», кнопка «Проверить все»). Запросы к OpenAI идут через PROXY_LIST.
   - Если прокси используются, но 403 остаётся — IP прокси может быть в заблокированном регионе; добавьте прокси из разрешённого региона или переключитесь на **Claude**.
   - При этой ошибке ордер **не блокируется** — внешний ИИ просто не даёт оценки.

   ---

   ## 7. Проверка

   - В админке на вкладке «Внешний ИИ» для каждого провайдера отображается **«ключ задан»**, если ключ сохранён (из админки или из `.env`).
   - Если ключ не задан или неверный, при включённом внешнем ИИ ордера не блокируются по этому фильтру (в логах — предупреждение).

   ---

   ## 8. Порядок фильтров перед открытием ордера

   1. Исполнение включено и есть ключи OKX.
   2. Risk/Reward ≥ 1.25.
   3. Внутренний AI-фильтр (minAiProb), если включён и модель «тёплая».
   4. **Внешний ИИ (OpenAI/Claude)**, если включён и ключ задан: оценка ≥ порог из админки.
   5. Открытие ордера через OKX.

   При ошибке или таймауте вызова внешнего ИИ ордер **не блокируется**.

   ---

   ## 9. Безопасность и шифрование ключей

   - Ключи, введённые в админке, сохраняются в БД. На фронте они **никогда не отображаются** (только статус «ключ задан»).
   - Для шифрования ключей в БД задайте в `.env` на сервере переменную **`ENCRYPTION_KEY`** (произвольная строка, например пароль). Без неё ключи хранятся в Base64 (обфускация), с нею — AES-256-GCM.
   - Опционально ключи можно задать в `.env` (`OPENAI_API_KEY`, `ANTHROPIC_API_KEY`) — они используются, если в БД ключ не задан.
