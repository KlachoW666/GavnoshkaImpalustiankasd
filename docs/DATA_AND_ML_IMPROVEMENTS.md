# Анализ папки /data и улучшения AI

## Папка data/

Папка `data/` (или путь из `DATABASE_PATH`) содержит:

| Файл | Описание |
|------|----------|
| `cryptosignal.db` | SQLite БД: ордера, настройки, пользователи, admin_tokens, signals и т.д. |
| `ml_model.json` | Модель онлайн ML: веса, число примеров, fedOrderIds. Создаётся автоматически. |

Папка создаётся при первом запуске. `data/` в `.gitignore`.

## Улучшения AI (onlineMLService)

### 1. Персистентность модели
- **Было:** веса и `sampleCount` только в памяти — сброс при перезапуске.
- **Стало:** модель сохраняется в `data/ml_model.json` после каждого обновления.
- При старте сервера модель загружается из файла.

### 2. Автообучение на закрытых ордерах
- **Было:** ML обновлялся только при вызове `POST /analyze-trades` (ручная передача сделок).
- **Стало:** при закрытии ордера (OKX sync, API PATCH/POST) он автоматически передаётся в ML.

### 3. Подгрузка закрытых ордеров с OKX
- Каждые 6 минут (okxSyncCron) запрашивается история закрытых ордеров с OKX по ключам пользователей (или глобальным из .env).
- Ордера с `realizedPnl` передаются в ML для обучения.
- Покрываются пары: BTC, ETH, SOL, XRP, DOGE, MATIC, ADA, DOT, AVAX, UNI.

### 4. Прогрев при старте
- При запуске загружаются последние 500 закрытых ордеров из БД.
- Те, что ещё не в `fedOrderIds`, передаются в модель.
- Модель быстрее «разогревается» после перезапуска.

### 5. Защита от дублей
- `fedOrderIds` сохраняется в `ml_model.json`.
- Один ордер обучает модель только один раз.

### 6. Вычисление risk/reward
- R:R считается из `open_price`, `stop_loss`, `take_profit` ордера.
- Улучшает качество признаков для обучения.

## Признаки модели (FEATURE_DIM = 9)

1. bias (константа)
2. confidence (0–1)
3. direction (1 = LONG, 0 = SHORT)
4. riskReward (нормализован 0–1, макс 4)
5. triggersCount
6. rsiBucket
7. volumeConfirm
8. atrNorm
9. spreadNorm

## Переменные окружения

- `ML_MIN_SAMPLES_GATE` — минимум примеров, после которого AI-фильтр (minAiProb) учитывается (по умолчанию 15).
- `DATABASE_PATH` — путь к БД; директория используется и для `ml_model.json`.
