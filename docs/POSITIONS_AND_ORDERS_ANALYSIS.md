# Анализ системы вычислений для позиций и ордеров

Дата: 2026-02

---

## 1. Текущая архитектура

### 1.1 Backend

| Компонент | Назначение |
|-----------|------------|
| **autoTrader.ts** | Открытие позиций на OKX: расчёт маржи (доля баланса × reserve), размера позиции (margin × leverage), округление amount по точности инструмента, SL/TP с учётом tpMultiplier. |
| **liquidationPrice.ts** | Цена ликвидации для isolated futures: MM_RATIO 0.4%, TAKER_FEE 0.05%, LIQUIDATION_BUFFER 5%. Формулы LONG/SHORT из документации OKX. |
| **orders (API + DB)** | Хранение ордеров: id, client_id, pair, direction, **size** (в USDT — номинал позиции), leverage, open_price, close_price, stop_loss, take_profit, pnl, pnl_percent, open_time, close_time, status. |
| **syncClosedOrdersFromOkx** | Синхронизация закрытых ордеров: по OKX realizedPnl или PnL = (priceChg%) × size (LONG/SHORT). **size в БД = номинал в USDT.** |
| **backtester.ts** | Симуляция по свечам: вход по RSI, SL/TP по ATR. **PnL в единицах цены на 1 контракт**, баланс в тех же единицах. Размер позиции не в USDT, нет плеча. |
| **copyTradingService** | Копирование сделки на подписчиков: тот же сигнал, sizePercent от баланса подписчика, executeSignal(). |

### 1.2 Frontend

| Компонент | Назначение |
|-----------|------------|
| **positionSizing.ts** | Расчёт размера по риску (Schwager): riskUsd = balance × riskPct, sizeUsd = riskUsd / stopPct. **Не используется в авто-торговле** — там только sizePercent от баланса. |
| **AutoTradingPage** | История из API (orders), локальные позиции (демо), закрытие позиции с расчётом PnL и отправкой PATCH /api/orders/:id. Отображение открытых позиций (OKX или локальные) с текущим PnL. |

### 1.3 Единицы измерения

- **В БД (orders.size)** — номинал позиции в USDT (position value = margin × leverage).
- **PnL в USDT** для закрытой позиции: `(closePrice - openPrice) / openPrice * size` (LONG) или `(openPrice - closePrice) / openPrice * size` (SHORT). Плечо в формулу не входит.
- **Нереализованный PnL** для открытой: `(markPrice - entryPrice) / entryPrice * notional` (LONG) или обратный знак (SHORT); notional = size в USDT.

---

## 2. Найденные проблемы и улучшения

### 2.1 Критично: формула PnL при закрытии позиции (фронт)

**Проблема:** В `AutoTradingPage.tsx` при ручном закрытии позиции (closePosition) PnL считается как:

```ts
pnl = ((price - pos.openPrice) / pos.openPrice) * pos.size * lev
```

Здесь `pos.size` уже приходит с API как **номинал в USDT**. Для USDT-M фьючерсов PnL в долларах = (изменение цены в долях) × номинал. Умножение на `lev` завышает PnL в `lev` раз.

**Исправление:** Убрать умножение на плечо:  
`pnl = ((price - pos.openPrice) / pos.openPrice) * pos.size` (LONG) и аналогично для SHORT. Тогда формула совпадает с бэкендом и с OKX.

---

### 2.2 Консистентность: отображение PnL открытой позиции

**Сейчас:** Для карточки открытой позиции используется  
`pnl = (pos.currentPrice - pos.openPrice) * (dir === 'SHORT' ? -1 : 1) * (pos.size / pos.openPrice)` — т.е. (Δprice) × (size/openPrice) = (Δprice) × контракты. При size в USDT: size/openPrice = notional/openPrice, что не равно количеству контрактов (контракты = notional/price в другой интерпретации). Для USDT-M: notional = size, контракты = size/entryPrice (в базовой валюте в единицах USDT эквивалента). Правильный нереализованный PnL: `(markPrice - entryPrice) / entryPrice * size` (LONG). Т.е. текущая формула `(currentPrice - openPrice) * (size / openPrice)` = (Δprice/openPrice) * size — это то же самое. Так что для открытой позиции формула верная. Ошибка только в closePosition (см. выше).

---

### 2.3 Бэктест: единицы и сопоставимость с реальной торговлей

**Проблема:** В бэктестере баланс и PnL выражены в единицах цены (на один «контракт»), начальный баланс 100 — абстрактные единицы. Нет размера позиции в USDT, нет плеча, нельзя напрямую сравнить с реальной кривой эквити в долларах.

**Предложение:**  
- Ввести опциональный режим: «симуляция в USDT» — initialBalance в USDT, размер позиции как доля баланса (или фикс в USDT), плечо, комиссии.  
- Считать PnL каждой сделки в USDT и обновлять balance в USDT.  
- Тогда метрики (maxDrawdown, profit factor, кривая эквити) будут сопоставимы с авто-торговлей.

---

### 2.4 Размер позиции: только % от баланса

**Сейчас:** В авто-торговле размер задаётся только как **sizePercent** от баланса и leverage. Риск на сделку (от расстояния до SL) явно не учитывается.

**Предложение:**  
- Оставить текущий режим по умолчанию.  
- Добавить опцию «по риску»: при наличии SL из сигнала считать размер из `positionSizing.calcPositionSizeFromRisk` (риск 1–2% от баланса, макс 3%), затем при необходимости ограничивать сверху долей баланса (как сейчас).  
- В UI: переключатель «Размер: % баланса / по риску (по стопу)».

---

### 2.5 Ликвидация: isolated vs cross

**Сейчас:** В `liquidationPrice.ts` используется формула для **isolated** margin (MM ratio, taker fee, buffer). На OKX при **cross** ликвидация зависит от всего портфеля.

**Предложение:**  
- В комментарии или в API явно указать: «расчёт для isolated».  
- При поддержке cross-режима добавить отдельную функцию или флаг, либо брать ликвидацию с API OKX (если доступно).

---

### 2.6 Минимальный объём и точность (OKX)

**Сейчас:** В `getOkxMinAmountAndPrecision` заданы только часть пар (BTC, ETH, SOL, DOGE, XRP, OP, ARB, RIVER). Остальные получают default 0.01, prec 2.

**Предложение:**  
- Расширить таблицу по мере добавления пар.  
- Либо при старте/периодически запрашивать у OKX инфацию по инструментам (min size, precision) и кэшировать.

---

### 2.7 Валидация и безопасность API ордеров

**Сейчас:** POST /api/orders и PATCH /api/orders/:id принимают body без схемы; проверяется только наличие id и closePrice. Нет привязки ордера к clientId при PATCH — теоретически можно обновить чужой ордер, зная id.

**Предложение:**  
- Ввести Zod-схемы для body (id, pair, direction, size, leverage, openPrice, stopLoss, takeProfit, status, closePrice, pnl и т.д.).  
- При PATCH проверять: ордер с данным id принадлежит clientId (из сессии или query). Для GET уже фильтр по clientId.

---

### 2.8 Резерв баланса (reserveRatio)

**Сейчас:** В autoTrader при balance < 50 используется reserveRatio 0.7, иначе 0.85; при balance < 20 дополнительно ограничение 15% баланса на одну позицию. Логика консервативная и понятная.

**Предложение:** Вынести пороги (50, 20) и коэффициенты (0.7, 0.85, 0.15) в конфиг или константы в начале файла, чтобы их можно было подстроить без правки логики.

---

## 3. Приоритеты внедрения

| Приоритет | Задача | Эффект |
|-----------|--------|--------|
| **P0** | Исправить формулу PnL при закрытии позиции (убрать × leverage) | Корректные цифры в истории и в уведомлениях |
| P1 | Валидация body для POST/PATCH orders + проверка владельца при PATCH | Безопасность и предсказуемость API |
| P2 | Опция размера позиции «по риску» (по стопу) в авто-торговле | Более предсказуемый риск на сделку |
| P3 | Бэктест в USDT (balance, size, leverage, комиссии) | Сопоставимость с реальной торговлей |
| P4 | Расширить getOkxMinAmountAndPrecision / запрос с OKX | Меньше отказов ордеров по минимуму |
| P5 | Конфигурируемый reserveRatio и пороги баланса | Гибкость без правки кода |

---

## 4. Итог

Система в целом согласована: в БД и в sync с OKX **size = номинал в USDT**, PnL считается от (priceChg%) × size. Единственная **критичная ошибка** — завышение PnL при ручном закрытии на фронте из‑за умножения на leverage. Остальные пункты — улучшения для сопоставимости бэктеста с реальностью, опции по риску, безопасность API и конфигурируемость.
